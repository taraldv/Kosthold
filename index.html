<!DOCTYPE html>
<html>
<head>
	<title>Kosthold</title>
	<meta charset="utf-8">
	<style type="text/css">
	*{
		margin: 0;
		padding:0;
		font-family: sans-serif;
		/*text-align: center;*/
	}
	body{
		background-color: whitesmoke;
		font-size: 1.2em;
		overflow-y:scroll;
	}
	#autocompleteDiv div strong {
		text-decoration: none;
		color: #0505FF;

	}

	#autocompleteDiv div{
		border-bottom: 1px solid grey;
		background-color: white;
	}
	#autocompleteDiv{
		width: 400px;
		text-align: left;
		position: absolute;
		z-index: 3;
		border: 1px solid grey;
	}
	.centerDiv{
		margin-bottom: 15px;
		padding-bottom: 15px;
		text-align: center;
		width: 50%;
		margin:auto;
		border-bottom: solid 1px black;
	}
	.autocompleteContainerDiv{
		display: inline-block;
	}
	.divButton{
		margin-left: 5px;
		padding-left: 5px;
		padding-right: 5px;
		border: 1px solid grey;
		display: inline-block;
	}
	.divButton:hover,#autocompleteDiv div:hover,.autocompleteDivSelected{
		cursor: pointer;
		background-color: #a0db8e;
	}
	input[type='number'] {
		margin-left: 5px;
		width: 50px;
		-moz-appearance:textfield;
	}
	input[type='submit']{
		width: 150px;
	}
	.removeFromCollectionDiv{
		width: 40%;
		margin: auto;
		padding: 5px;
	}
	.removeFromCollectionDiv:hover{
		cursor: pointer;
		background-color: #DB8EA0;
	}
	.removeFromCollectionDiv input{
		pointer-events: none;
	}
	.collection div input{
		font-size: 0.8em;
		width: 300px;
	}
	#innholdDiv div div input{
		font-size: 0.8em;
		width: 100px;
	}
	#innholdDiv div input{
		font-size: 0.8em;
		width: 50px;
	}
	.collection div input:last-child{
		margin-left: 5px;
		font-size: 0.8em;
		width: 50px;
	}
	input{
		font-size: 1em;
		width: 400px;
	}
	.inlineDiv{
		display: inline-block;
	}
</style>
</head>
<body>
	<script type="text/javascript" src="githubIgnore.js"></script>
	<script type="text/javascript">

		buildHTML();

		function buildHTML(){
			var loggDiv = getDiv("centerDiv");
			loggDiv.appendChild(getLoggForm());

			var måltidDiv = getDiv("centerDiv");
			måltidDiv.appendChild(getMåltidForm());
			
			var nyMatvareDiv = getDiv("centerDiv");
			nyMatvareDiv.appendChild(getMatvaretabellForm());
			

			document.body.appendChild(loggDiv);
			document.body.appendChild(måltidDiv);
			document.body.appendChild(nyMatvareDiv);
		}

		function getMatvaretabellFormData(){
			var output = "";
			var matvaretabellInputDiv = document.getElementById("innholdDiv");
			var children = matvaretabellInputDiv.children;
			for(i=0;i<children.length;i++){
				var tempChildren = children[i].children;
				var text = tempChildren[0].firstChild.value;
				var number = tempChildren[1].value;
				if(!number){
					number = 0;
				}
				if(!text){
					text = 0;
				}
				output += "&matvaretabellMatvare"+i+"="+text+"&maatvaretabellInnhold"+i+"="+number
			}
			return output;
		}

		function getMatvaretabellForm(){

			var standard = ["Kilojoule","Kilokalorier","Fett","Karbohydrat","Sukker, tilsatt","Protein","Salt"];

			var form = document.createElement("form");
			form.setAttribute("autocomplete","off");
			form.onsubmit = function(){
				var matvaretabellInputNavn = document.getElementById("matvaretabellInputNavn");
				var navn = matvaretabellInputNavn.value;
				var oReq = new XMLHttpRequest();
				oReq.addEventListener('load',function(){
					handleInsertResponse(this.response);
				})
				oReq.open("POST", url, true);
				oReq.setRequestHeader("Content-type", "application/x-www-form-urlencoded;charset=utf-8");
				oReq.send("type=insertMatvaretabell"+"&navn="+navn+getMatvaretabellFormData());
				return false;
			};

			var matvaretabellSubmit = document.createElement("input");
			matvaretabellSubmit.setAttribute("type","submit");

			var addButton = getDiv("divButton");
			addButton.innerText = "Legg til innhold";
			addButton.addEventListener("click",function(){
				leggTilInnholdForMatvare();
			})

			var innholdDiv = getDiv("noClass","innholdDiv");

			
			var matvaretabellInputNavnBeskrivelse = getDiv();
			matvaretabellInputNavnBeskrivelse.innerText = "ny matvare navn";

			var matvaretabellInputNavn = document.createElement("input");
			matvaretabellInputNavn.setAttribute("type","text");
			matvaretabellInputNavn.setAttribute("id","matvaretabellInputNavn");

			var matvaretabellInputNavnBeskrivelseDiv = getDiv("inlineDiv");
			matvaretabellInputNavnBeskrivelseDiv.appendChild(matvaretabellInputNavnBeskrivelse);
			matvaretabellInputNavnBeskrivelseDiv.appendChild(matvaretabellInputNavn);

			form.appendChild(matvaretabellInputNavnBeskrivelseDiv);
			form.appendChild(addButton);
			form.appendChild(matvaretabellSubmit);
			form.appendChild(innholdDiv);

			for(i = 0;i<standard.length;i++){
				innholdDiv.appendChild(leggTilInnholdForMatvare(standard[i]));
			}

			return form;
		}

		function autocompleteFocusOut(){
			this.setAttribute("id","");
		}

		function autocompleteFocusIn(){
			this.setAttribute("id","activatedAutocomplete");
		}

		function leggTilInnholdForMatvare(tekst){
			var typeInput = document.createElement("input");
			typeInput.setAttribute("type","text");
			typeInput.setAttribute("data-tabell","næringsinnhold");
			typeInput.addEventListener("keyup",autocomplete);
			typeInput.addEventListener("focusin",autocompleteFocusIn)
			typeInput.addEventListener("focusout",autocompleteFocusOut);

			var verdiInput = document.createElement("input");
			verdiInput.setAttribute("type","number");
			verdiInput.setAttribute("step",".01");
			verdiInput.setAttribute("class","numberInput");

			var autocompleteContainer = getDiv("autocompleteContainerDiv");
			autocompleteContainer.appendChild(typeInput);

			var containerDiv = document.createElement("div");
			containerDiv.appendChild(autocompleteContainer);
			containerDiv.appendChild(verdiInput);

			if(tekst){
				typeInput.value = tekst;
				return containerDiv;
			}

			document.getElementById("innholdDiv").appendChild(containerDiv);
		}

		function handleInsertResponse(response){
			if(response == 1){
				window.location.reload();
			} else {
				var bodyNode = document.body;
				removeChildren(bodyNode);
				bodyNode.insertAdjacentHTML('afterbegin',error);
			}
		}

		function getMåltidForm(){
			var form = document.createElement("form");
			form.setAttribute("autocomplete","off");
			form.onsubmit= function(){
				var måltidNavnInput = document.getElementById("måltidNavnInput");
				var navn = måltidNavnInput.value;
				if(navn.length>1){
					var oReq = new XMLHttpRequest();
					oReq.addEventListener('load',function(){
						handleInsertResponse(this.response);
					});
					oReq.open("POST", url, true);
					oReq.setRequestHeader("Content-type", "application/x-www-form-urlencoded;charset=utf-8");
					oReq.send("type=insertMåltider"+"&navn="+navn+getCollectionDataForForm("måltidCollection"));
					
				}
				return false;
			};
			form.setAttribute("id","måltidForm");

			var måltidNavnInput = document.createElement("input");
			måltidNavnInput.setAttribute("type","text");
			måltidNavnInput.setAttribute("id","måltidNavnInput");

			var måltidNavnBeskrivelse = document.createElement("div");
			måltidNavnBeskrivelse.innerText = "måltid navn";

			var måltidNavnBeskrivelseDiv = getDiv("inlineDiv")
			måltidNavnBeskrivelseDiv.appendChild(måltidNavnBeskrivelse);
			måltidNavnBeskrivelseDiv.appendChild(måltidNavnInput);

			var måltidSubmit = document.createElement("input");
			måltidSubmit.setAttribute("type","submit");

			var måltidCollectionDiv = getDiv("collection","måltidCollection")

			form.appendChild(måltidNavnBeskrivelseDiv);
			form.appendChild(måltidSubmit);
			form.appendChild(getMatvareInputWithAutocompleteDiv("matvaretabellen","måltidCollection"));
			form.appendChild(måltidCollectionDiv);

			return form;
		}

		function getCollectionDataForForm(collection){
			var output = "";
			var matvareCollection = document.getElementById(collection);
			var divChildren = matvareCollection.children;
			for(i=0;i<divChildren.length;i++){
				var tempInputChildren = divChildren[i].children;
				var tempId = tempInputChildren[0].getAttribute("data-id");
				var tempMengde = tempInputChildren[1].value;
				output += "&matvareId"+i+"="+tempId+"&matvareMengde"+i+"="+tempMengde;
			}
			return output;
		}

		function getLoggForm(){
			var form = document.createElement("form");
			form.setAttribute("autocomplete","off");
			form.onsubmit = function(){
				var oReq = new XMLHttpRequest();
				oReq.addEventListener('load',function(){
					handleInsertResponse(this.response);
				})
				oReq.open("POST", url, true);
				oReq.setRequestHeader("Content-type", "application/x-www-form-urlencoded;charset=utf-8");
				oReq.send("type=insertLogg"+getCollectionDataForForm("matvareCollection"));
				return false;
			};

			var loggSubmit = document.createElement("input");
			loggSubmit.setAttribute("type","submit")

			var matvareCollection = getDiv("collection","matvareCollection");

			form.appendChild(getMatvareInputWithAutocompleteDiv("matvaretabellen","matvareCollection"));
			form.appendChild(loggSubmit);
			form.appendChild(matvareCollection);
			return form;
		}


		function autocomplete(){
			removeAutocompleteDiv();
			var parent = this.parentNode;
			var tabell = this.getAttribute("data-tabell");
			var oReq = new XMLHttpRequest();
			oReq.addEventListener('load',function(){
				var obj = JSON.parse(this.response);
				var whichInputActivatedAutocomplete = document.getElementById("activatedAutocomplete");
				activatedAutocomplete.parentNode.appendChild(getAutocompleteDiv(obj));
			})
			oReq.open("POST", url, true);
			oReq.setRequestHeader("Content-type", "application/x-www-form-urlencoded;charset=utf-8");
			oReq.send("type=autocomplete&string="+this.value+"&table="+tabell);
		}

		function getMatvareInputWithAutocompleteDiv(databaseNavn,whichCollection){
			var matvareInput = document.createElement("input");
			matvareInput.setAttribute("type","text");
			matvareInput.setAttribute("data-tabell",databaseNavn);
			matvareInput.addEventListener('keyup',autocomplete);
			matvareInput.addEventListener("focusin",autocompleteFocusIn);
			matvareInput.addEventListener("focusout",autocompleteFocusOut);
			/*matvareInput.onkeyup = function(event){
				var autocompleteActive = document.getElementById("autocompleteDiv");
				console.log(autocompleteActive);
				if(event.key=="ArrowDown" && autocompleteActive){
					autocompleteFocusOut();
				}
			};*/

			var autocompleteContainer = getDiv("autocompleteContainerDiv")
			autocompleteContainer.appendChild(matvareInput);

			var matvareBeskrivelse = document.createElement("div");
			matvareBeskrivelse.innerText = "matvare";

			var matvareBeskrivelseDiv = getDiv("inlineDiv");
			matvareBeskrivelseDiv.appendChild(matvareBeskrivelse);
			matvareBeskrivelseDiv.appendChild(autocompleteContainer);

			var matvareMengdeInput = document.createElement("input");
			matvareMengdeInput.setAttribute("type","number");
			matvareMengdeInput.setAttribute("id","matvareMengdeInput");

			var mengdeBeskrivelse = document.createElement("div");
			mengdeBeskrivelse.innerText = "gram";

			var mengdeBeskrivelseDiv = getDiv("inlineDiv");
			mengdeBeskrivelseDiv.appendChild(mengdeBeskrivelse);
			mengdeBeskrivelseDiv.appendChild(matvareMengdeInput);

			var lagreMatvareButtonDiv = getDiv("divButton");
			lagreMatvareButtonDiv.innerHTML = "Lagre matvare";
			lagreMatvareButtonDiv.addEventListener("click",function(){

				var matvareInput = this.parentNode.firstChild.lastChild.firstChild;

				var gramInput = this.parentNode.firstChild.nextSibling.lastChild;

				var matvareCollection = document.getElementById(whichCollection);
				var tempDiv = getDiv("removeFromCollectionDiv");
				tempDiv.addEventListener("click",function(){
					this.remove();
				});

				var tempNavnInput = document.createElement("input");
				tempNavnInput.setAttribute("disabled","");
				tempNavnInput.setAttribute("data-id",matvareInput.getAttribute("data-id"));
				tempNavnInput.value = matvareInput.value;

				var tempMengdeInput = document.createElement("input");
				tempMengdeInput.setAttribute("disabled","");
				tempMengdeInput.value = gramInput.value;

				tempDiv.appendChild(tempNavnInput);
				tempDiv.appendChild(tempMengdeInput);
				matvareCollection.appendChild(tempDiv);
				matvareInput.value = "";
				gramInput.value = "";
			})

			var mainDiv = getDiv("inlineDiv");
			mainDiv.appendChild(matvareBeskrivelseDiv);
			mainDiv.appendChild(mengdeBeskrivelseDiv);
			mainDiv.appendChild(lagreMatvareButtonDiv);

			return mainDiv;
		}

		function checkMåltidNavn(navn){
			var oReq = new XMLHttpRequest();
			oReq.addEventListener('load',function(){
				var måltidNavnInput = document.getElementById("måltidNavnInput");
				var obj = JSON.parse(this.response);
				inputValidering(måltidNavnInput,!obj[0],"Navnet eksisterer allerede");
			})
			oReq.open("POST", url, true);
			oReq.setRequestHeader("Content-type", "application/x-www-form-urlencoded;charset=utf-8");
			oReq.send("type=checkMåltider&string="+navn);
		}

		function inputValidering(inputNode,boolean,errorTekst){
			inputNode.setCustomValidity("");
			inputNode.parentNode.classList.remove("has-error");
			if (!boolean) {
				inputNode.setCustomValidity(errorTekst);
				inputNode.parentNode.classList.add("has-error");
			}
		}


		function highlightString(original, stringToMatch){
			var index = original.toLowerCase().indexOf(stringToMatch.toLowerCase());
			var beforeString = original.slice(0,index);
			var slicedString = original.slice(index,index+stringToMatch.length);
			var afterString = original.slice(index+stringToMatch.length);
			return beforeString.concat("<strong>"+slicedString+"</strong>",afterString);
		}

		function removeAutocompleteDiv(){
			var elem = document.getElementById("autocompleteDiv");
			if(elem){
				elem.remove();
			}

		}

		function getAutocompleteDiv(json){
			var autocompleteDiv = getDiv("noClass","autocompleteDiv")

			var searchWord = json.search;
			var length = Object.keys(json).length;

			for(i=0;i<length-1;i++){
				var keys = Object.keys(json[i]);
				var tempDiv = document.createElement("div");
				tempDiv.setAttribute("data-id",json[i][keys[1]]);
				var wholeString = json[i][keys[0]];

				tempDiv.innerHTML = highlightString(wholeString,searchWord)

				tempDiv.addEventListener("click",function(){
					var parent = this.parentNode.parentNode;
					var firstChild = parent.firstChild;
					firstChild.value = this.innerText;
					firstChild.setAttribute("data-id",this.getAttribute("data-id"));
					removeAutocompleteDiv();
				})
				autocompleteDiv.appendChild(tempDiv);
			}
			return autocompleteDiv;
		}

		function getDiv(className,idName){
			var div = document.createElement("div");
			if(className){
				div.setAttribute("class",className);
			}
			if(idName){
				div.setAttribute("id",idName);
			}
			return div;
		}

		function removeChildren(myNode){
			while (myNode.firstChild) {
				myNode.removeChild(myNode.firstChild);
			}
		}

	</script>
</body>
</html>